'use client'

import MessageCommonAvatar from '@/features/message/components/common/MessageCommonAvatar'
import MessageCommonItemContent from '@/features/message/components/common/MessageCommonItemContent'
import MessageCommonItemTitle from '@/features/message/components/common/MessageCommonItemTitle'
import Link from 'next/link'
import { LikeDTO, MessageListItem, MessageSourceType } from '@mtobdvlb/shared-types'
import WithAt from '@/components/hoc/WithAt'
import MessageCommonItemMetaData from '@/features/message/components/common/MessageCommonItemMetaData'
import MessageCommonItemBtn from '@/features/message/components/common/MessageCommonItemBtn'
import MessageCommonItemCover from '@/features/message/components/common/MessageCommonItemCover'
import { Ref } from 'react'
import { useLike, useLikeGet } from '@/features'
import { cn } from '@/lib'

const MessageReplyListItem = ({
  ref,
  item,
  index,
  total,
}: {
  item: MessageListItem
  index: number
  ref: Ref<HTMLDivElement>
  total: number
}) => {
  const likeParams: LikeDTO = {
    feedId: item.sourceType === 'feed' ? item.sourceId : item.sourceId,
    commentId: item.sourceType === 'comment' ? item.sourceId : undefined,
    videoId: item.sourceType === 'video' ? item.sourceId : undefined,
  } satisfies LikeDTO

  const { unlike, like } = useLike(likeParams)
  const { isLike } = useLikeGet(likeParams)

  return (
    <div
      className={'relative cursor-pointer flex group'}
      ref={index === total - 1 ? ref : null}
      key={item.id}
    >
      <MessageCommonAvatar src={item.fromUser.avatar ?? ''} userId={item.fromUser.id ?? ''} />
      <MessageCommonItemContent item={item}>
        <MessageCommonItemTitle>
          <Link
            onClick={(e) => e.stopPropagation()}
            target={'_blank'}
            href={`/apps/web/src/app/(with-auth)/space/${item.fromUser.id}`}
            className={'font-bold decoration-0 hover:text-brand_blue text-text1'}
          >
            {item.fromUser.name}
          </Link>
          <span className={'text-text2 ml-2'}>
            {
              (
                {
                  comment: ' 回复了我的评论',
                  video: ' 对我的视频发表了评论',
                  feed: ' 对我的动态发表了评论',
                } as Record<MessageSourceType, string>
              )[item.sourceType ?? 'video']
            }
          </span>
        </MessageCommonItemTitle>
        <div
          className={
            'whitespace-pre-wrap mt-2.5 text-sm leading-4.5 text-text1 line-clamp-2 text-ellipsis'
          }
        >
          <WithAt>{item.content ?? ''}</WithAt>
        </div>
        {!item.myContent?.startsWith('http') && (
          <div
            className={
              'border-l-2 border-l-line_regular mt-2 mb-2.5 pl-1 text-xs leading-4 w-full overflow-hidden text-ellipsis line-clamp-2 text-text3'
            }
          >
            {!item.myContent?.startsWith('http') && item.myContent}
          </div>
        )}
        <MessageCommonItemMetaData item={item}>
          {/*<MessageCommonItemBtn className={'h-full hover:text-brand_blue'}>*/}
          {/*  <svg*/}
          {/*    xmlns='http://www.w3.org/2000/svg'*/}
          {/*    viewBox='0 0 16 16'*/}
          {/*    width='16'*/}
          {/*    height='16'*/}
          {/*    className={'size-4 '}*/}
          {/*  >*/}
          {/*    <path*/}
          {/*      d='M1.3333333333333333 7C1.3333333333333333 4.05448 3.7211466666666664 1.6666666666666665 6.666666666666666 1.6666666666666665L9.333333333333332 1.6666666666666665C12.278833333333333 1.6666666666666665 14.666666666666666 4.05448 14.666666666666666 7C14.666666666666666 9.843699999999998 12.440933333333334 12.167499999999999 9.636533333333333 12.324333333333332C8.998166666666666 13.1427 7.948533333333334 14.1686 6.474246666666667 14.570333333333332C6.1891333333333325 14.648 5.92802 14.526299999999999 5.782006666666666 14.338366666666666C5.6404266666666665 14.156166666666666 5.59028 13.894933333333334 5.695926666666666 13.651666666666666C5.9177133333333325 13.141033333333333 5.963839999999999 12.672799999999999 5.933633333333333 12.281633333333334C3.3350933333333335 11.9255 1.3333333333333333 9.696666666666665 1.3333333333333333 7zM6.666666666666666 2.6666666666666665C4.273433333333333 2.6666666666666665 2.333333333333333 4.606766666666666 2.333333333333333 7C2.333333333333333 9.306033333333332 4.134893333333333 11.191666666666666 6.407 11.3257C6.633393333333332 11.339066666666668 6.822433333333334 11.5031 6.867533333333332 11.725366666666666C6.9593 12.177299999999999 6.987066666666667 12.741999999999999 6.825866666666666 13.367066666666666C7.792633333333333 12.938366666666667 8.513233333333332 12.171699999999998 8.978566666666666 11.537333333333333C9.071733333333333 11.410333333333334 9.219333333333333 11.334666666666665 9.376833333333334 11.333133333333333C11.749966666666666 11.309833333333332 13.666666666666666 9.378699999999998 13.666666666666666 7C13.666666666666666 4.606766666666666 11.726566666666665 2.6666666666666665 9.333333333333332 2.6666666666666665L6.666666666666666 2.6666666666666665z'*/}
          {/*      fill='currentColor'*/}
          {/*    ></path>*/}
          {/*  </svg>*/}
          {/*  <span>回复</span>*/}
          {/*</MessageCommonItemBtn>*/}
          <MessageCommonItemBtn
            onClick={() => (isLike ? unlike() : like())}
            className={cn('hover:text-brand_blue', isLike && 'text-brand_blue')}
          >
            {isLike ? (
              <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16' height='16'>
                <path
                  d='M13.545733333333333 5.166653333333333L10.511766666666666 5.166653333333333C10.658033333333332 4.851813333333333 10.821733333333334 4.440706666666666 10.880833333333332 4.044453333333333C10.923233333333332 3.760413333333333 10.927266666666664 3.412493333333333 10.893133333333333 3.0813333333333333C10.859833333333334 2.7581999999999995 10.784866666666666 2.3969066666666663 10.6352 2.1132133333333334C10.318299999999999 1.5124266666666666 9.882166666666667 1.09052 9.357366666666666 0.9881599999999999C8.799166666666666 0.8792866666666665 8.318566666666666 1.1633 8.030966666666666 1.59852C7.7904333333333335 1.9625133333333333 7.6966 2.26618 7.611066666666667 2.5431266666666668L7.608366666666666 2.5519066666666665C7.526133333333332 2.817973333333333 7.4452333333333325 3.07934 7.237266666666667 3.4476933333333335C6.895133333333334 4.053713333333333 6.615993333333333 4.36802 6.240833333333333 4.69694C6.046326666666666 4.867473333333333 5.84366 4.974753333333333 5.666666666666666 5.03686L5.666666666666666 14.149866666666664C6.190953333333333 14.161133333333334 6.752166666666666 14.168266666666668 7.333333333333333 14.168266666666668C8.896066666666666 14.168266666666668 10.214966666666665 14.117266666666666 11.084633333333333 14.071433333333333C11.938133333333333 14.026433333333333 12.754100000000001 13.5962 13.1998 12.814466666666664C13.621066666666666 12.075666666666665 14.160633333333333 10.9572 14.485833333333334 9.619766666666667C14.7904 8.367233333333333 14.9174 7.348799999999999 14.968999999999998 6.656493333333334C15.032466666666666 5.8043733333333325 14.340166666666665 5.166653333333333 13.545733333333333 5.166653333333333zM4.666666666666666 14.122666666666667L4.666666666666666 5.166653333333333L3.5348733333333335 5.166653333333333C2.506193333333333 5.166653333333333 1.591813333333333 5.90056 1.4747533333333334 6.9655C1.4003066666666666 7.642799999999999 1.3333333333333333 8.523499999999999 1.3333333333333333 9.5016C1.3333333333333333 10.559333333333333 1.4116666666666666 11.540700000000001 1.4928399999999997 12.274533333333332C1.6048399999999998 13.287066666666664 2.43944 14.026599999999998 3.4350066666666668 14.073566666666666C3.78952 14.0903 4.205413333333333 14.107633333333332 4.666666666666666 14.122666666666667z'
                  fill='currentColor'
                ></path>
              </svg>
            ) : (
              <svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' width='16' height='16'>
                <path
                  d='M9.283433333333333 1.6969733333333332C9.095466666666667 1.6750599999999998 8.921333333333333 1.7568066666666664 8.828166666666666 1.8657866666666667C8.424633333333333 2.3377999999999997 8.332133333333333 3.031613333333333 8.029333333333334 3.5679133333333333C7.630633333333333 4.27412 7.258833333333333 4.701153333333333 6.800866666666666 5.102673333333334C6.42382 5.43324 6.042199999999999 5.654626666666666 5.666666666666666 5.757786666666666L5.666666666666666 12.816366666666667C6.19062 12.827766666666665 6.751966666666666 12.835 7.333333333333333 12.835C8.831233333333333 12.835 10.1019 12.787433333333333 10.958166666666665 12.743366666666667C11.565133333333332 12.7121 12.091966666666666 12.411766666666667 12.366466666666668 11.9234C12.7516 11.238266666666664 13.2264 10.233566666666666 13.514166666666664 9.050166666666666C13.7823 7.947466666666667 13.904599999999999 7.041 13.959466666666666 6.40168C13.984933333333332 6.105313333333333 13.750433333333334 5.833353333333333 13.386666666666665 5.833353333333333L10.065133333333332 5.833353333333333C9.898433333333333 5.833353333333333 9.742666666666667 5.750286666666666 9.649833333333333 5.611833333333333C9.536066666666667 5.442159999999999 9.560033333333333 5.2495199999999995 9.6312 5.070013333333333C9.783966666666666 4.680513333333333 9.983933333333333 4.0995133333333325 10.062766666666667 3.571206666666667C10.1406 3.0496733333333332 10.121599999999999 2.6306133333333332 9.917133333333332 2.2429266666666665C9.697399999999998 1.8263599999999998 9.448266666666665 1.7161933333333332 9.283433333333333 1.6969733333333332zM10.773433333333333 4.833353333333333L13.386666666666665 4.833353333333333C14.269133333333333 4.833353333333333 15.036999999999999 5.54194 14.9558 6.487253333333333C14.897 7.1722 14.767199999999999 8.1294 14.485833333333334 9.286466666666666C14.170333333333334 10.583866666666665 13.6532 11.675133333333331 13.238166666666666 12.413433333333332C12.7729 13.2411 11.910266666666667 13.695666666666668 11.009566666666666 13.742033333333334C10.14 13.786833333333334 8.851766666666666 13.835 7.333333333333333 13.835C5.862206666666666 13.835 4.51776 13.789766666666667 3.565173333333333 13.7463C2.4932333333333334 13.697399999999998 1.5939999999999999 12.901133333333334 1.4786599999999999 11.810133333333333C1.4028 11.092733333333332 1.3333333333333333 10.164466666666666 1.3333333333333333 9.168333333333333C1.3333333333333333 8.255633333333332 1.3916466666666667 7.427899999999999 1.4598999999999998 6.771133333333333C1.5791666666666666 5.6236266666666666 2.5641 4.833353333333333 3.671693333333333 4.833353333333333L5.166666666666666 4.833353333333333C5.3793066666666665 4.833353333333333 5.709213333333333 4.729853333333333 6.141613333333333 4.350746666666666C6.516733333333333 4.02186 6.816366666666667 3.6823333333333332 7.158533333333333 3.0762799999999997C7.5023 2.4673999999999996 7.6041 1.7586733333333333 8.068066666666667 1.2159866666666665C8.372133333333332 0.8603133333333333 8.8718 0.6422 9.399233333333333 0.7037066666666667C9.949866666666665 0.7679066666666667 10.457733333333334 1.1244533333333333 10.801633333333331 1.7763799999999998C11.148866666666665 2.43466 11.143799999999999 3.1023266666666665 11.051833333333335 3.71876C10.993899999999998 4.106886666666666 10.875366666666666 4.519026666666666 10.773433333333333 4.833353333333333zM4.666666666666666 12.788833333333333L4.666666666666666 5.833353333333333L3.671693333333333 5.833353333333333C3.029613333333333 5.833353333333333 2.5161533333333335 6.281713333333333 2.4545466666666664 6.874499999999999C2.3890599999999997 7.5046 2.333333333333333 8.2971 2.333333333333333 9.168333333333333C2.333333333333333 10.120099999999999 2.399833333333333 11.011933333333333 2.473113333333333 11.705C2.533993333333333 12.2808 3.0083466666666667 12.719866666666665 3.6107466666666665 12.747366666666666C3.9228066666666668 12.761566666666667 4.278173333333333 12.776 4.666666666666666 12.788833333333333z'
                  fill='currentColor'
                ></path>
              </svg>
            )}
            <span>{isLike ? '已赞' : '点赞'}</span>
          </MessageCommonItemBtn>
        </MessageCommonItemMetaData>
        <MessageCommonItemCover content={item.myContent ?? ''} />
      </MessageCommonItemContent>
    </div>
  )
}

export default MessageReplyListItem
